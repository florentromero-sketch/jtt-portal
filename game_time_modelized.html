<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚙️ Game Time Modelized – Brother in Arm + Sum War Power</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: 'Orbitron', sans-serif;
    background: radial-gradient(circle at 20% 20%, #081625 0%, #040d17 100%);
    color: #b5e9f8;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }
  h1 {
    font-size: 1rem;
    text-shadow: 0 0 12px #00eaff;
    color: #00eaff;
    margin-bottom: 14px;
    letter-spacing: 1.5px;
    text-align: center;
  }
  .widget {
    background: linear-gradient(180deg, rgba(8,22,37,0.95) 0%, rgba(4,13,23,0.95) 100%);
    width: 100%;
    max-width: 480px;
    border-radius: 12px;
    box-shadow: inset 0 0 20px rgba(0,239,255,0.15), 0 0 25px rgba(0,239,255,0.3);
    overflow: hidden;
    padding: 16px;
  }
  .tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 14px;
  }
  .tab {
    background: linear-gradient(90deg, #05283b 0%, #07334a 100%);
    color: #00eaff;
    font-weight: 700;
    border: none;
    padding: 6px 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 1px;
    text-transform: uppercase;
  }
  .tab.active {
    background: linear-gradient(90deg, #00eaff 0%, #19b3fe 100%);
    color: #02131f;
    box-shadow: 0 0 18px rgba(0,239,255,0.4);
  }
  canvas {
    width: 100% !important;
    height: 260px !important;
  }
  .summary {
    margin-top: 10px;
    color: #77dfff;
    text-align: center;
    letter-spacing: 1px;
    font-size: 0.9rem;
  }
</style>
</head>
<body>
<h1>⚙️ Game Time Modelized – Brother in Arm + Sum War Power</h1>

<div class="widget">
  <div class="tabs">
    <button class="tab active" id="weeklyBtn">WEEKLY</button>
    <button class="tab" id="voidBtn">VOID</button>
  </div>
  <canvas id="chart"></canvas>
  <div class="summary" id="summary">Chargement des données...</div>
</div>

<script>
const ctx = document.getElementById('chart').getContext('2d');
const D = { weekly: { power: [], players: [] }, void: { power: [], players: [] } };

// === couleurs & gradients ==
const gradPower = ctx.createLinearGradient(0, 0, 0, 300);
gradPower.addColorStop(0, "rgba(0,255,255,0.25)");
gradPower.addColorStop(1, "rgba(0,155,255,0)");
const gradPlayers = ctx.createLinearGradient(0, 0, 0, 300);
gradPlayers.addColorStop(0, "rgba(179,136,255,0.25)");
gradPlayers.addColorStop(1, "rgba(179,136,255,0.05)");

const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: Array.from({ length: 24 }, (_, i) => `${i}h`),
    datasets: [
      {
        label: "💪🌐 Sum War Power (M)",
        data: [],
        borderColor: '#00ffee',
        backgroundColor: gradPower,
        borderWidth: 3,
        fill: true,
        tension: 0.35,
        pointRadius: 4,
        pointHoverRadius: 6,
        pointBackgroundColor: '#00ffe0',
        yAxisID: 'y'
      },
      {
        label: "👥 Brothers in Arm (Players)",
        data: [],
        borderColor: '#b388ff',
        backgroundColor: gradPlayers,
        borderWidth: 2,
        fill: true,
        tension: 0.35,
        pointRadius: 3,
        pointHoverRadius: 5,
        pointBackgroundColor: '#b388ff',
        yAxisID: 'y1'
      }
    ]
  },
  options: {
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    animation: { duration: 800, easing: 'easeInOutQuart' },
    plugins: {
      legend: { labels: { color: '#00eaff', font: { size: 11 } } },
      tooltip: {
        callbacks: { label: c => `${c.dataset.label}: ${c.parsed.y.toFixed(1)}` }
      }
    },
    scales: {
      y: {
        type: 'linear',
        position: 'left',
        beginAtZero: true,
        min: 0,
        title: { text: 'Power (M)', display: true, color: '#00ffff' },
        ticks: {
          callback: v => v >= 1_000_000 ? (v/1_000_000).toFixed(0)+' M' : v,
          color: '#00ffff'
        },
        grid: { color: 'rgba(0,255,255,0.08)', tickLength: 0 }
      },
      y1: {
        type: 'linear',
        position: 'right',
        beginAtZero: true,
        min: 0,
        title: { text: 'Players', display: true, color: '#b388ff' },
        ticks: { stepSize: 10, color: '#b388ff' },
        grid: { drawOnChartArea: false }
      },
      x: {
        ticks: { color: '#5dd9ff' },
        grid: { color: 'rgba(0,255,255,0.08)', tickLength: 0 }
      }
    }
  }
});

// === heure & résumé ===
const summary = document.getElementById('summary');
function currentHourIndexUTC0() { return new Date().getUTCHours() % 24; }

function updateSummary(type) {
  const h = currentHourIndexUTC0();
  const p = D[type].power[h] || 0;
  const b = D[type].players[h] || 0;
  summary.textContent = `🕘 ${h}h UTC • 💪 Power : ${p.toFixed(1)} M ⚡ – 👥 Players : ${b}`;
  chart.data.datasets.forEach(ds => {
    ds.pointRadius = ds.data.map((_, i) => i === h ? 6 : 3);
  });
}

// === switch ===
function switchData(type) {
  chart.data.datasets[0].data = D[type].power;
  chart.data.datasets[1].data = D[type].players;
  chart.update();
  updateSummary(type);
}

// === pulse ==
let pulse = 0;
function animate() {
  pulse += 0.04;
  const glow = 0.5 + Math.sin(pulse) * 0.5;
  chart.data.datasets[0].borderColor = `rgba(0,255,255,${0.55 + glow * 0.3})`;
  chart.data.datasets[1].borderColor = `rgba(179,136,255,${0.55 + glow * 0.3})`;
  chart.update('none');
  requestAnimationFrame(animate);
}
animate();

// === Sheets ===
async function fetchSheetData(gid) {
  const sheetId = '1QMna4_NnamMeNUvU69dOOqwhIL07QgLlZ5mrKTU3xZs';
  const rangePlayers = 'C127:AA127';
  const rangePower = 'C189:AA189';

  async function fetchRange(range) {
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${gid}&range=${range}`;
    const res = await fetch(url);
    const txt = await res.text();
    const json = JSON.parse(txt.substring(47).slice(0,-2));
    return json.table.rows[0].c.map(c => {
      if (!c || c.v === null) return 0;
      const v = parseFloat(c.v.toString().replace(',','.').replace(/[^\d.-]/g,''));
      return isNaN(v) ? 0 : v;
    });
  }

  try {
    const [players, power] = await Promise.all([
      fetchRange(rangePlayers),
      fetchRange(rangePower)
    ]);
    console.log(`✅ gid=${gid}: ${players.length} players, ${power.length} power`);

    // fermer la boucle 0h : duplique le premier point s'il manque
    if (power.length === 24) {
      power.push(power[0]);
      players.push(players[0]);
    }

    return { players, power };
  } catch (e) {
    console.error('Erreur Sheets:', e);
    return { players: [], power: [] };
  }
}

// === load JTT ===
async function loadJTTData() {
  const [weekly, voidD] = await Promise.all([
    fetchSheetData(0),
    fetchSheetData(1434850621)
  ]);
  if (Math.max(...weekly.power) > 1000)
    weekly.power = weekly.power.map(v => v / 1_000_000);
  if (Math.max(...voidD.power) > 1000)
    voidD.power = voidD.power.map(v => v / 1_000_000);
  D.weekly = weekly;
  D.void = voidD;
  setTimeout(() => switchData('weekly'), 200);
}
loadJTTData();

// === onglets ===
const weeklyBtn = document.getElementById('weeklyBtn');
const voidBtn = document.getElementById('voidBtn');
weeklyBtn.onclick = () => {
  weeklyBtn.classList.add('active');
  voidBtn.classList.remove('active');
  switchData('weekly');
};
voidBtn.onclick = () => {
  voidBtn.classList.add('active');
  weeklyBtn.classList.remove('active');
  switchData('void');
};
</script>
</body>
</html>
