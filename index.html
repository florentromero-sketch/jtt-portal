<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>🛰 JTT Data Portal 🛰</title>

<!-- 🔹 PWA META -->
<link rel="manifest" href="manifest.json" />
<meta name="theme-color" content="#1f8cff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="icon-192.png" />

<!-- 🔹 DESIGN ORIGINAL BLEU‑NÉON -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');

body {
  font-family:'Orbitron',sans-serif;
  background:radial-gradient(circle at center,#041226 0%,#000000 90%);
  color:#d4f1ff;
  margin:0;padding:0;text-align:center;
}
h1{color:#00caff;text-shadow:0 0 10px #00caff,0 0 20px #00caff;margin:1rem 0;font-size:1.3rem;}
.panel,.graph{
  border:1px solid #00caff;border-radius:10px;
  box-shadow:0 0 14px #00caff55;
  margin:1rem auto;padding:1rem;
  width:90%;max-width:600px;background:#021020;
}
h2{color:#ffcf73;text-shadow:0 0 6px #ffcf73aa;font-size:1rem;margin-bottom:0.6rem;}
.progress-container{background:#010a14;border:1px solid #00334d;border-radius:5px;overflow:hidden;margin:0.8rem auto;height:18px;width:90%;}
.progress-bar{background:linear-gradient(90deg,#00caff,#00ffaa);height:100%;width:0%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:#001820;font-weight:bold;transition:width .6s;}
.stat-line{margin:.4rem 0;}
.btn{display:block;margin:.4rem auto;width:80%;max-width:260px;padding:.6rem 1rem;border:1px solid #00caff99;border-radius:6px;background:linear-gradient(90deg,#011b32,#012d52);color:#8efad8;text-decoration:none;cursor:pointer;transition:.2s;font-size:.9rem;}
.btn:hover{background:linear-gradient(90deg,#02345f,#014e85);}
.tabs{display:flex;justify-content:center;margin:.6rem 0;}
.tab{background:#01223e;border:1px solid #00caff55;border-radius:6px;color:#00caff;margin:0 .3rem;padding:.3rem .8rem;cursor:pointer;}
.tab.active{background:#00caff;color:#021020;box-shadow:0 0 10px #00d8ff;}
.summary{color:#00ffaa;margin-top:.6rem;font-size:.9rem;}
footer{color:#006e8a;font-size:.8rem;margin:1.5rem 0;}
#splashScreen{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:#000d1a;display:flex;align-items:center;justify-content:center;
  z-index:9999;color:#00caff;font-size:1.2rem;letter-spacing:1px;transition:opacity .5s;
}

/* 🎯 NOUVEAU CSS GRAPHIQUE RESPONSIVE */
canvas {
  display:block;
  width:100%!important;
  max-width:100%;
  background:#010a14;
  border:1px solid #012d52;
  border-radius:8px;
  box-shadow:0 0 6px #012d5280;
  margin-top:0.5rem;
}
@media (max-width:600px){
  canvas{min-height:220px;height:220px!important;}
}
@media (min-width:601px){
  canvas{min-height:300px;height:320px!important;}
}
</style>
</head>

<body>
<div id="splashScreen">🛰 JTT data Loading...</div>

<h1>📡 JTT Data Portal</h1>

<div class="panel">
  <h2>📄 FEUILLE : STATS ALLIANCE</h2>
  <p>Member census. Data auto‑updated.</p>
  <div class="progress-container">
    <div id="fillBar" class="progress-bar"><span id="fillText">Loading…</span></div>
  </div>
  <p class="stat-line">Membres enregistrés : <span id="count">--</span> / <span id="total">--</span></p>
  <a href="#" class="btn">🧾 New Registration</a>
  <a href="#" class="btn">📊 JTT Data System</a>
  <a href="#" class="btn">🎯 My Personal Link</a>
  <a href="#" class="btn">🔁 Refresh</a>
</div>

<div class="graph">
  <h2>📈 GAME TIME MODELIZED – BROTHER IN ARM + SUM WAR POWER</h2>
  <div class="tabs">
    <button class="tab active" id="weeklyBtn">WEEKLY</button>
    <button class="tab" id="voidBtn">VOID</button>
  </div>
  <canvas id="chart"></canvas>
  <div class="summary" id="summary">Loading data...</div>
</div>

<footer>© JTT Alliance Management V3.6</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* ------- Compteur des membres ------- */
const fillBar=document.getElementById("fillBar"),
      fillText=document.getElementById("fillText"),
      count=document.getElementById("count"),
      total=document.getElementById("total");

async function loadStats(){
 try{
   const res=await fetch("https://docs.google.com/spreadsheets/d/1QMna4_NnamMeNUvU69dOOqwhIL07QgLlZ5mrKTU3xZs/gviz/tq?tqx=out:csv&gid=1508042555");
   const text=await res.text();
   const rows=text.trim().split("\n").map(r=>r.split(",").map(c=>c.replace(/(^\"|\"$)/g,"")));
   const cleanNums=(rows[1]||[]).map(v=>parseInt(String(v).replace(/\D/g,"")||"0",10)).filter(n=>!isNaN(n)&&n>0);
   const cur=cleanNums[0]||0,tot=cleanNums[1]||100;
   const pct=Math.min(Math.round((cur/tot)*100),100);
   fillBar.style.width=pct+"%";
   fillText.textContent=pct+"% completed";
   count.textContent=cur; total.textContent=tot;
 }catch(e){
   console.error("loadStats() error:",e);
   fillText.textContent="❌ Data Error";
 }
}
loadStats();

/* ------- Chart configuration ------- */
const ctx=document.getElementById('chart');
ctx.height = window.innerWidth<600 ? 220 : 320;  // ✅ hauteur adaptée mobile/PC

const dataSets={weekly:{power:[],players:[]},void:{power:[],players:[]}};
const gradient=ctx.getContext('2d').createLinearGradient(0,0,0,300);
gradient.addColorStop(0,"rgba(0,255,255,.25)");
gradient.addColorStop(1,"rgba(0,255,255,0)");

const chart=new Chart(ctx,{
 type:'line',
 data:{
  labels:Array.from({length:25},(_,i)=>i<24?`${i}h`:"24h"),
  datasets:[
   {label:"💪 Sum War Power (M)",data:[],borderColor:'#00ffee',backgroundColor:gradient,borderWidth:2,tension:.25,fill:true,pointRadius:2,hoverRadius:4,pointBackgroundColor:'#00ffe0',yAxisID:'y'},
   {label:"👥 Brothers in Arm (Players)",data:[],borderColor:'#00bfff',backgroundColor:"rgba(0,255,255,.08)",borderWidth:1.8,tension:.25,fill:true,pointRadius:2,hoverRadius:4,yAxisID:'y1'}
  ]},
 options:{
  responsive:true,
  maintainAspectRatio:false,  // ✅ désactivation pour ajustement fluide
  layout:{padding:{left:5,right:5,top:5,bottom:5}},
  plugins:{
    legend:{position:'bottom',labels:{color:'#00eaff',font:{size:9}}},
    tooltip:{backgroundColor:'#02131f',titleColor:'#00ffff',bodyColor:'#e1b46a',titleFont:{size:10},bodyFont:{size:9}}
  },
  scales:{
    x:{ticks:{color:'#66eaff',font:{size:8}},grid:{color:'rgba(0,255,255,.05)'}},
    y:{beginAtZero:true,ticks:{color:'#00ffff',font:{size:8}},grid:{color:'rgba(0,255,255,.08)'}},
    y1:{position:'right',beginAtZero:true,ticks:{color:'#00ffff',font:{size:8}},grid:{drawOnChartArea:false}}
  }
 }});

/* ------- Google Sheets data / chart fill ------- */
async function getRange(gid,range){
 const u=`https://docs.google.com/spreadsheets/d/1QMna4_NnamMeNUvU69dOOqwhIL07QgLlZ5mrKTU3xZs/gviz/tq?tqx=out:json&gid=${gid}&range=${range}`;
 const res=await fetch(u);
 const txt=await res.text();
 const json=JSON.parse(txt.substring(47).slice(0,-2));
 return json.table.rows[0].c.map(c=>parseFloat(String(c?.v??0).replace(',','.'))||0);
}
async function initData(){
 const [W,V]=await Promise.all([
  Promise.all([getRange(0,'C127:AA127'),getRange(0,'C189:AA189')]),
  Promise.all([getRange(1434850621,'C127:AA127'),getRange(1434850621,'C189:AA189')])
 ]);
 dataSets.weekly={players:W[0],power:W[1].map(v=>v/1_000_000)};
 dataSets.void={players:V[0],power:V[1].map(v=>v/1_000_000)};
 switchData('weekly');
}
function switchData(mode){
 chart.data.datasets[0].data=dataSets[mode].power;
 chart.data.datasets[1].data=dataSets[mode].players;
 chart.update(); updateSummary(mode);
}
function updateSummary(mode){
 const h=(new Date()).getUTCHours()%24;
 const p=dataSets[mode].power[h]||0;
 const b=dataSets[mode].players[h]||0;
 summary.textContent=`🕘 ${h}h UTC – Power ${p.toFixed(1)} M ⚡ Players ${b}`;
}
const weeklyBtn=document.getElementById('weeklyBtn'),
      voidBtn=document.getElementById('voidBtn'),
      summary=document.getElementById('summary');
weeklyBtn.onclick=()=>{weeklyBtn.classList.add('active');voidBtn.classList.remove('active');switchData('weekly');};
voidBtn.onclick=()=>{voidBtn.classList.add('active');weeklyBtn.classList.remove('active');switchData('void');};
initData();

/* ------- Splash Screen ------- */
window.addEventListener('load',()=>{
 const s=document.getElementById('splashScreen');
 setTimeout(()=>{s.style.opacity='0';setTimeout(()=>{s.style.display='none';},500);},2000);
});

/* ------- Service Worker ------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/jtt-portal/service-worker.js')
  .then(()=>console.log('✅ Service Worker enregistré'))
  .catch(e=>console.error('❌ SW Erreur',e));
}
</script>
</body>
</html>